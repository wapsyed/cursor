---
title: "Introdução à estatística"
output: html_document
date: "2024-11-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r fig.height=2, fig.width=5, dpi = 72}
library(tidyverse)
library(esquisse)
library(patchwork)
library(here)
library(ggsci)
```


# Poucas amostras
## Um grupo
```{r fig.height=8, fig.width=5, dpi = 72}
set.seed = 123

normal_dist = rnorm(20, mean = 30, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params = normal_dist %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

right_skew = rchisq(20, df = 3) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

right_skew_params = right_skew %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

left_skew = -sqrt(right_skew$distribution) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

left_skew_params = left_skew %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))
```

Normal
```{r fig.height=8, fig.width=5, dpi = 72}
normal_points = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
      scale_x_continuous(expand = c(0.01,0.01))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


normal_jitter = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white") +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")



normal_hist = normal_dist %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 10) +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

normal_boxplot = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_boxplot() +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")

normal_violin = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_normal_dist = normal_points /
  normal_jitter/
  normal_hist /
  normal_boxplot +
  normal_violin + 
  plot_layout(axes = "collect",
              heights = c(0.2, 0.5, 1, 1, 1))

patch_normal_dist

patch_normal_dist %>% 
  ggsave(filename = here("Figuras", "Distribuicao_normal_20Amostras.png"),
         width = 5,
         height = 8)
```


Deslocado para a direita
```{r fig.height=8, fig.width=5, dpi = 72}
right_skew_points = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 10)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


right_skew_jitter = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white") +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 10)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")



right_skew_hist = right_skew %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 5) +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 10)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

right_skew_boxplot = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_boxplot() +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 10)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")

right_skew_violin = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 10)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_right_skew_dist = right_skew_points /
  right_skew_jitter/
  right_skew_hist /
  right_skew_boxplot +
  right_skew_violin + 
  plot_layout(axes = "collect",
              heights = c(0.2, 0.5, 1, 1, 1))

patch_right_skew_dist

patch_right_skew_dist %>% 
  ggsave(filename = here("Figuras", "Distribuicao_right_skewed_PoucasAmostras.png"),
         width = 5,
         height = 8)
```



## Dois grupos

Dois grupos, Muito separados, pvalue < 0.00000005
```{r fig.height=5, fig.width=5, dpi = 72}

set.seed = 123

normal_dist_1 = rnorm(20, mean = 30, sd = 2) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_2 = rnorm(20, mean = 50, sd = 2) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G2")

normal_dist_2groups = bind_rows(normal_dist_1, 
                                normal_dist_2)

normal_dist_2groups_params = normal_dist_2groups %>% 
  group_by(group) %>% 
  summarize(mean = mean(distribution),
            median = median(distribution)) %>% 
  ungroup()

normal_points = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group,
      color = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2) +
  theme_minimal() +
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")

normal_violin = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(aes(fill = group),
              alpha = 0.1) +
  geom_boxplot(aes(fill = group),width = 0.3) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


normal_hist = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      fill = group) +
   geom_histogram(bins = 5, alpha = 0.5) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


patch_normal_dist_2groups = normal_points /
  normal_violin/
  normal_hist + 
  plot_layout(axes = "collect",
              guides = "collect",
              heights = c(0.5, 1, 1))

patch_normal_dist_2groups

patch_normal_dist_2groups %>% 
  ggsave(filename = here("Figuras", "Distribuicao_2grupos_MenosAmostras_P05.png"),
         width = 5,
         height = 3)
```

2 grupos, pouco separados
```{r fig.height=5, fig.width=5, dpi = 72}

set.seed = 123

normal_dist_1 = rnorm(20, mean = 45, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_2 = rnorm(20, mean = 47, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G2")

normal_dist_2groups = bind_rows(normal_dist_1, 
                                normal_dist_2)

normal_dist_2groups_params = normal_dist_2groups %>% 
  group_by(group) %>% 
  summarize(mean = mean(distribution),
            median = median(distribution)) %>% 
  ungroup()

normal_points = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group,
      color = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2) +
  theme_minimal() +
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")

normal_violin = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(aes(fill = group),
              alpha = 0.1) +
  geom_boxplot(aes(fill = group),width = 0.3) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +

  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


normal_hist = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      fill = group) +
   geom_histogram(bins = 5L, alpha = 0.5) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 8)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


patch_normal_dist_2groups = normal_points /
  normal_violin/
  normal_hist + 
  plot_layout(axes = "collect",
              guides = "collect",
              heights = c(0.5, 1, 1))

patch_normal_dist_2groups

patch_normal_dist_2groups %>% 
  ggsave(filename = here("Figuras", "Distribuicao_2grupos_poucosep_PoucasAmostras.png"),
         width = 5,
         height = 3)
```



# Muitas amostras
## Um grupo
```{r fig.height=8, fig.width=5, dpi = 72}
set.seed = 123

normal_dist = rnorm(200, mean = 30, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params = normal_dist %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

right_skew = rchisq(100, df = 3) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

right_skew_params = right_skew %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

left_skew = -sqrt(right_skew$distribution) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

left_skew_params = left_skew %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))
```

Normal
```{r fig.height=5, fig.width=5, dpi = 72}
normal_points = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
      scale_x_continuous(expand = c(0.01,0.01))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


normal_jitter = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white") +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")



normal_hist = normal_dist %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 10) +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

normal_boxplot = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_boxplot() +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")

normal_violin = normal_dist %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = normal_dist_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_normal_dist = normal_points /
  normal_jitter/
  normal_hist /
  normal_boxplot +
  normal_violin + 
  plot_layout(axes = "collect",
              heights = c(0.2, 0.5, 1, 1, 1))

patch_normal_dist

patch_normal_dist %>% 
  ggsave(filename = here("Figuras", "Distribuicao_normal.png"),
         width = 5,
         height = 8)
```


Deslocado para a direita
```{r fig.height=5, fig.width=5, dpi = 72}
right_skew_points = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 20)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


right_skew_jitter = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white") +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 20)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")



right_skew_hist = right_skew %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 10) +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 20)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

right_skew_boxplot = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_boxplot() +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 20)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")

right_skew_violin = right_skew %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = right_skew_params$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = right_skew_params$median, color = "#05C7F2FF",
             size = 1) +
      scale_x_continuous(expand = c(0.01,0.01), n.breaks = 20)+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_right_skew_dist = right_skew_points /
  right_skew_jitter/
  right_skew_hist /
  right_skew_boxplot +
  right_skew_violin + 
  plot_layout(axes = "collect",
              heights = c(0.2, 0.5, 1, 1, 1))

patch_right_skew_dist

patch_right_skew_dist %>% 
  ggsave(filename = here("Figuras", "Distribuicao_right_skewed.png"),
         width = 5,
         height = 8)
```



## Dois grupos

Dois grupos, pvalue < 0.00000005
```{r fig.height=5, fig.width=5, dpi = 72}

set.seed = 123

normal_dist_1 = rnorm(100, mean = 30, sd = 2) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_2 = rnorm(100, mean = 50, sd = 2) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G2")

normal_dist_2groups = bind_rows(normal_dist_1, 
                                normal_dist_2)

normal_dist_2groups_params = normal_dist_2groups %>% 
  group_by(group) %>% 
  summarize(mean = mean(distribution),
            median = median(distribution)) %>% 
  ungroup()

normal_points = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group,
      color = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2) +
  theme_minimal() +
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")

normal_violin = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(aes(fill = group),
              alpha = 0.1) +
  geom_boxplot(aes(fill = group),width = 0.3) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


normal_hist = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      fill = group) +
   geom_histogram(bins = 20L, alpha = 0.5) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


patch_normal_dist_2groups = normal_points /
  normal_violin/
  normal_hist + 
  plot_layout(axes = "collect",
              guides = "collect",
              heights = c(0.5, 1, 1))

patch_normal_dist_2groups

patch_normal_dist_2groups %>% 
  ggsave(filename = here("Figuras", "Distribuicao_2grupos.png"),
         width = 5,
         height = 3)
```

2 grupos, pouco separados
```{r fig.height=5, fig.width=5, dpi = 72}

set.seed = 123

normal_dist_1 = rnorm(100, mean = 45, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_2 = rnorm(100, mean = 47, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G2")

normal_dist_2groups = bind_rows(normal_dist_1, 
                                normal_dist_2)

normal_dist_2groups_params = normal_dist_2groups %>% 
  group_by(group) %>% 
  summarize(mean = mean(distribution),
            median = median(distribution)) %>% 
  ungroup()

normal_points = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group,
      color = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2) +
  theme_minimal() +
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")

normal_violin = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(aes(fill = group),
              alpha = 0.1) +
  geom_boxplot(aes(fill = group),width = 0.3) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +

  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


normal_hist = normal_dist_2groups %>% 
  ggplot() +
  aes(x = distribution, 
      fill = group) +
   geom_histogram(bins = 20L, alpha = 0.5) +
  scale_x_continuous(expand = c(0.1,0.1), n.breaks = 10)+
  scale_fill_manual(values = c("black", "#05C7F2FF")) +
  scale_color_manual(values = c("black", "#05C7F2FF")) +
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        legend.position = "none") +
  labs(y = "",
       x = "")


patch_normal_dist_2groups = normal_points /
  normal_violin/
  normal_hist + 
  plot_layout(axes = "collect",
              guides = "collect",
              heights = c(0.5, 1, 1))

patch_normal_dist_2groups

patch_normal_dist_2groups %>% 
  ggsave(filename = here("Figuras", "Distribuicao_2grupos_poucosep.png"),
         width = 5,
         height = 3)
```


# Comparando muitas e poucas amostras (desvio padrão pequeno)
## Desvio padrão baixo
```{r fig.height=3, fig.width=5, dpi = 72}
set.seed = 123

normal_dist_few = rnorm(5, mean = 30, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params_few = normal_dist_few %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

normal_dist_many = rnorm(100, mean = 30, sd = 1) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params_many = normal_dist_many %>% 
  summarize(mean = mean(distribution),
            median = median(distribution))

normal_points = normal_dist_few %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params_few$mean, color = "black",
             size = 1) +
  geom_vline(xintercept = normal_dist_params_few$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "",
       title = "n = 5, sd = 1")

normal_hist = normal_dist_few %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 25) +
    geom_vline(xintercept = normal_dist_params_few$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_few$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

normal_violin = normal_dist_few %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = normal_dist_params_few$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_few$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_normal_dist_few = normal_points /
  normal_hist /
  # normal_violin + 
  plot_layout(axes = "collect",
              heights = c(0.5, 1))

normal_points = normal_dist_many %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params_many$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_many$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "",
       title = "n = 100, sd = 1")



normal_hist = normal_dist_many %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 25) +
    geom_vline(xintercept = normal_dist_params_many$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_many$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

normal_violin = normal_dist_many %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_violin(fill = "black", alpha = 0.1) +
  geom_jitter(shape = 21, size = 2.5, stroke = 0.5, color = "black", fill = "white",
              width = 0.0005) +
  geom_boxplot(width = 0.3) +
    geom_vline(xintercept = normal_dist_params_many$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_many$median, color = "#05C7F2FF",
             size = 1) +
    scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "")


patch_normal_dist_many = normal_points /
  normal_hist /
  # normal_violin + 
  plot_layout(axes = "collect",
              heights = c(0.5, 1))


patch_normal_dist_few | patch_normal_dist_many 
```
## Desvio padrão grande
```{r fig.height=3, fig.width=5, dpi = 72}
set.seed = 123

normal_dist_few = rnorm(5, mean = 30, sd = 5) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params_few = normal_dist_few %>% 
  summarize(mean = mean(distribution),
            median = median(distribution),
            min = min(distribution),
            max = max(distribution))

normal_dist_many = rnorm(100, mean = 30, sd = 5) %>% 
  as.data.frame() %>% 
  rename(distribution = ".") %>% 
  mutate(group = "G1")

normal_dist_params_many = normal_dist_many %>% 
  summarize(mean = mean(distribution),
            median = median(distribution),
            min = min(distribution),
            max = max(distribution))

normal_points = normal_dist_few %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params_few$mean, color = "black",
             size = 1) +
  geom_vline(xintercept = normal_dist_params_few$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
    # scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "",
       title = "n = 5, sd = 5")

normal_hist = normal_dist_few %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 25) +
    geom_vline(xintercept = normal_dist_params_few$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_few$median, color = "#05C7F2FF",
             size = 1) +
    # scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")


patch_normal_dist_few = normal_points /
  normal_hist /
  plot_layout(axes = "collect",
              heights = c(0.5, 1))

normal_points = normal_dist_many %>% 
  ggplot() +
  aes(x = distribution, 
      y = group) +
  geom_point(size = 2.5,
             color = "black") +
  geom_point(size = 2,
             color = "white") +
  geom_vline(xintercept = normal_dist_params_many$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_many$median, color = "#05C7F2FF",
             size = 1) +
  theme_minimal() +
    # scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+

  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12)) +
  labs(y = "",
       x = "",
       title = "n = 100, sd = 5")



normal_hist = normal_dist_many %>% 
  ggplot() +
  aes(x = distribution) +
  geom_histogram(color = "white",
                 fill = "#1D373AFF",
                 size = 0.5,
                 alpha = 1,
                 bins = 25) +
    geom_vline(xintercept = normal_dist_params_many$mean, color = "black",
             size = 1,) +
  geom_vline(xintercept = normal_dist_params_many$median, color = "#05C7F2FF",
             size = 1) +
    # scale_x_continuous(expand = c(0.01,0.01), limits = c(27, 33))+
  theme_minimal() +
  theme(axis.line.x = element_line(size = 1),
        text = element_text(color = "black",
                            size = 12),
        panel.grid.minor.y = element_blank()) +
  labs(y = "",
       x = "")

patch_normal_dist_many = normal_points /
  normal_hist /
  plot_layout(axes = "collect",
              heights = c(0.5, 1))

patch_normal_dist_few | patch_normal_dist_many 
```




# Analisando dados de vacinação: distribuições e uma pincelada de estatística

Em um conjunto de dados que registra a cobertura vacinal ao longo do tempo para diferentes países, é comum encontrar registros ausentes (e NAs) para determinados países em determinados anos. Isso pode ser devido a vários motivos, como a introdução tardia de determinadas vacinas em alguns países ou a falta de disponibilidade de dados.

Para investigar se há algum padrão na frequência de países que registram a cobertura vacinal ao longo dos anos, podemos criar um gráfico que represente essa frequência. Uma abordagem interessante é agrupar os países por região da OMS e observar se há um aumento na quantidade de países que começaram a registrar a cobertura vacinal ao longo do tempo.

É importante ressaltar que estamos avaliando a frequência de países que registram a cobertura vacinal por ano e não a qualidade da cobertura vacinal em si.

**Quantos países por região da OMS registraram os dados na UNICEF?**

Observa-se que algumas vacinas, como BCG, DTP1, DTP3, POL3 e MCV1, já apresentam registros desde o ano de 1980, com a participação de muitos países. Isso ocorre devido ao fato de que essas vacinas já faziam parte do calendário de imunização de diversos países. No entanto, é importante ressaltar que nem todos os países podem ter reportado sua cobertura vacinal à OMS nesse período, ou até mesmo podem não ter implementado a vacinação.

Por outro lado, algumas vacinas, como IPV1 e MCV2, começaram a ser registradas após o ano 2000, mas já contam com a participação de muitos países nos registros. Isso se deve ao fato de que essas vacinas estavam disponíveis muito antes do início dos registros, evidenciando sua ampla adoção em diferentes países.

Além disso, é possível observar que algumas vacinas começaram a ser registradas de forma gradual ao longo do tempo, como HEPBB, HEPB3, PCV3, HIB3 e ROTAC. Esse padrão faz sentido, uma vez que essas vacinas foram desenvolvidas mais recentemente em comparação com as mencionadas anteriormente.

Um caso interessante é o da vacina contra febre amarela (YFV), que existe desde a década de 1930. Surpreendentemente, sua cobertura vacinal apresenta um comportamento semelhante ao das vacinas introduzidas mais recentemente. Além disso, é importante observar que nem todas as regiões registram essa vacina, sendo mais concentrada em áreas tropicais onde a doença é endêmica.

Essas observações mostram a complexidade e a heterogeneidade na implementação e registro da cobertura vacinal em diferentes regiões e ao longo do tempo. Ainda, refletem as diferentes políticas de saúde pública e condições epidemiológicas em todo o mundo.

```{r message=FALSE, warning=FALSE, fig.width = 10, fig.height = 10}
#Quantos países por continente registraram os dados na UNICEF?
#Todos os continentes juntos
cobertura_vacinal %>%
 filter(type == "country") %>% 
  select(coverage, year, continent, vaccine) %>% 
  mutate(continent = fct_reorder(continent, coverage)) %>% 
  drop_na(coverage) %>% 
  ggplot() +
  aes(x = year, fill = continent) +
  geom_histogram(bins = 43L) +
  theme_few()  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  facet_wrap(~vaccine, scale= "free_y") +
    labs(title = "Cobertura vacinal por Continente",
       subtitle = "Diferentes vacinas",
       x = "Anos",
       y = "",
       fill = "Continente") +
  scale_fill_jama()
```

**Qualidade da cobertura vacinal: Os países aumentaram sua cobertura vacinal ao longo das décadas?**

Para visualizar a distribuição de dados em diferentes grupos, como regiões, podemos recorrer a um tipo de gráfico conhecido como **ridgeline**. Esses gráficos apresentam curvas de densidade sobrepostas, o que permite uma comparação direta entre as distribuições de cada grupo. Por exemplo, ao analisar a cobertura vacinal em diferentes regiões, podemos observar se os países convergem para um valor específico ou se apresentam variações significativas.

```{r message=FALSE, warning=FALSE}
#Pacote para o gráfico de ridgelines
library(ggridges) 

cobertura_vacinal %>%
 filter(type == "country",
        year %in% c(1990,2000, 2010, 2020),
        diseases == "Measles") %>%
  mutate(continent = fct_rev(continent)) %>% 
 ggplot() +
  aes(x = coverage, y = continent, fill = fct_rev(continent)) +
   geom_density_ridges() +
  theme_few()+
  theme(plot.caption = element_text(size = 13L),
        legend.position = "none",
        axis.text.x = element_text(angle = 90),
        strip.text.y = element_text(angle = 0, 
                                    hjust = 0)) +
  facet_grid(~vaccine~year, scales = "free_y") +
  labs(title = "Cobertura vacinal por Região da OMS",
       subtitle = "Vacinas contra sarampo",
       x = "Cobertura (%)",
       y = "",
       fill = "Região da OMS") +
  scale_fill_jama() 

```

Quando todos os países de uma região têm valores semelhantes, a curva de densidade apresenta um único pico agudo. Nesse caso, esse pico representa a **moda**,a **mediana** e a **média** da distribuição, que são **medidas de centralidade**. A moda é o valor mais frequente. Além disso, também identificamos a **mediana**, que corresponde ao valor do meio quando os dados estão ordenados, e a **média**, que é calculada somando todos os valores e dividindo pelo número total de observações.

No entanto, quando os países dentro de uma região apresentam coberturas vacinais diferentes, a curva de densidade tende a se achatar, indicando uma distribuição mais dispersa, e as medidas de centralidade não têm o mesmo valor.

Em alguns casos, é possível observar dois ou mais picos distintos, o que caracteriza uma distribuição **bimodal** ou **multimodal**, dependendo do número de picos identificados. Isso é importante para identificar padrões em diferentes grupos ou categorias. Observe também que a cobertura vacinal para a maioria dos países aumentou ao longo das décadas, convergindo para 90 a 100%.

Todavia, uma **curva** é uma suavização dessas frequências em um intervalo de valores. Usando um **histograma**, que nada mais é do que um gráfico de barras, podemos ver melhor essas nuances. Observe que o que foi modificado no código foram os argumentos usados na função `geom_density_ridges()`, com `stat = "binline"` e o número de `bins`. As bins são as discretizações de uma variável contínua, como a cobertura vacinal. Ou seja, dividimos o intervalo de 0-100% em 20. Se aumentarmos essas bins para 100, o gráfico ficará mais detalhado, mas menos informativo, mas o contrário também será verdade.

Altere os valores e veja os resultados.

```{r message=FALSE, warning=FALSE}
#Qual a cobertura vacinal nos anos 1990 e 2019 para vacinas contra o sarampo?
cobertura_vacinal %>%
 filter(type == "country",
        year %in% c(2000, 2010, 2020),
        diseases == "Measles") %>%
  mutate(continent = fct_rev(continent)) %>% 
 ggplot() +
  aes(x = coverage, y = continent, fill = fct_rev(continent)) +
   geom_density_ridges(stat = "binline", bins = 20) +
  theme_few()+
  theme(plot.caption = element_text(size = 13L),
        legend.position = "none",
        axis.text.x = element_text(angle = 90),
        strip.text.y = element_text(angle = 0, 
                                    hjust = 0)) +
  facet_grid(~vaccine~year, scales = "free") +
  labs(title = "Cobertura vacinal por Região da OMS",
       subtitle = "Vacinas contra sarampo",
       x = "Cobertura (%)",
       y = "",
       fill = "Região da OMS") +
  scale_fill_jama()
```

## Dados demográficos e econômicos com o Gapminder

O gapminder é um site e um pacote que apresenta diferentes dados sobre países ao longo dos anos. O pacote do R traz uma tabela dos anos 50 até 2007, com dados sobre expectativa de vida, PIB percapita e tamanho da população. Vamos ver se a cobertura vacinal tem alguma relação com a expectativa de vida nos países. Além disso, vamos classificar os páises de acordo com seu PIB per capita, seguindo a classificação da ONU.

```{r message=FALSE, warning=FALSE}
#Manipulação
gapminder_vac = gapminder %>% 
  left_join(cobertura_vacinal %>% rename(country = name) %>% select(-continent),
            by = join_by(country, year))  %>% 
  mutate(income = case_when(
    gdpPercap < 1035 ~ "Low Income",
    gdpPercap >= 1035 & gdpPercap < 4085 ~ "Lower Middle Income",
    gdpPercap >= 4085 & gdpPercap < 12615 ~ "Upper Middle Income",
    gdpPercap >= 12615 ~ "High Income"
  ))

#Plot
gapminder_vac %>% 
  filter(vaccine == "BCG") %>% 
ggplot() +
  aes(
    x = coverage,
    y = lifeExp,
  ) +
  geom_point(aes(colour = continent,
    size = pop),
    shape = "circle") +
  facet_wrap(~year)+
  theme_few() +
  labs(title = "Cobertura vacinal e Expectativa de vida",
       subtitle = "Vacina BCG", 
       x = "Cobertura vacinal (%)",
       y = "Expecativa de vida (anos)",
       color = "Região",
       shape = "População") +
  scale_color_jama()
```

Aparentemente, quando a cobertura vacinal para a **BCG** aumenta, a expectativa de vida também aumenta, e isso ocorre ao longo dos anos. Além disso, veja que, principalmente entre 1982 e 1992, os países seguem um comportamento bem parecido com o de uma reta na diagonal.

Em estatística, se duas variáveis se relacionam gerando formatos lineares (retas) ou não lineares (curvas), dizemos que elas estão **associadas**. Mas, qual a **direção** e **força** dessa associação? Bem, neste caso, se as duas aumentam juntas, dizemos que há uma **correlação positiva (\>0)**. Mas, **quão positiva** ela é?

Neste caso, sabemos que elas **parecem** seguir uma **reta**, mas precisamos forçar um pouco, porque elas estão dispersas. Quanto mais os pontos se agrupam e menor é a dispersão, maior é a força dessa correlação. Além disso, por mais que os pontos pareçam se agrupar em uma reta, há diferentes formas de traçá-la, com angulos diferentes. A técnica que encontra a melhor reta em um gráfico de dispersão é chamada de **regressão**, que no caso é **linear**.

No gráfico abaixo, usamos as funções `geom_smooth()` do ggplot2 e `stat_correlation()` do pacote `ggpmisc` para fazer a regressão linear e apresentar o coeficiente de correlação R (método de Pearson). Além disso, também calculamos o grau de dispersão dos pontos em relação à reta. Quando o R^2^ está mais próximo de 1, menor é a dispersão em torno da reta e melhor essa reta explica o comportamento. Por exemplo, se o R for 1, a correlação é positiva e forte, e se R^2^ for próximo de 1, podemos **predizer** que, a partir de um valor na variável do eixo X, o valor correspondente na variável do eixo Y será **predito** com alto grau de confiança.

Em **estatística** e em **machine learning**, é comum atribuir nomes diferentes aos mesmos conceitos. Por exemplo, a variável no eixo X é denominada **variável independente** na estatística e **preditor** no contexto de machine learning. Já a variável no eixo Y é referida como **variável dependente** na estatística, enquanto no âmbito de machine learning, é denominada **variável resposta ou outcome**. Entender isso é importante porque, embora não exploraremos as técnicas e conceitos de machine learning, no presente curso, você pode se perder nesses diferentes contextos.

Observe que o maior valor de **R** foi de 0.61 e de **R^2^**, de 0.37. Somente de observar os gráficos, vemos que esses resultados corroboram com a dispersão dos países, com muitos nas extremidades dos gráficos. Neste caso, podemos dizer que, apesar de uma associação entre as variáveis, a correlação é positiva e com força intermediária. Além disso, **a cobertura vacinal somente explica 37% da variação da expectativa de vida entre os países**.

```{r message=FALSE, warning=FALSE}

gapminder_vac %>% 
  filter(vaccine == "BCG") %>% 
ggplot() +
  aes(x = coverage,
    y = lifeExp) +
  geom_point(shape = "circle",
             aes(colour = continent,
                 size = pop),
             alpha = 0.2) +
  geom_smooth(method = "lm",
              color = "black",
              se = F)+
  stat_correlation(method = "pearson",
                   size = 3,
                   mapping = use_label(c("R", "R2"))) +
  facet_wrap(~year)+
  theme_few() +
  labs(title = "Cobertura vacinal e Expectativa de vida",
       subtitle = "Vacina BCG", 
       x = "Cobertura vacinal (%)",
       y = "Expecativa de vida (anos)",
       color = "Continente",
       shape = "População") +
  scale_color_jama()
```

Ao aplicarmos a regressão linear considerando todos os países, estamos ignorando as distinções proporcionadas pelos continentes. Cada região apresenta uma variabilidade entre seus países, e, em média, uma região pode apresentar um comportamento distinto das demais. Diante disso, surgem diversas questões que poderiam contribuir para explicar essa variação regional, como fatores geográficos, sociais e econômicos. Assim, para uma análise mais aprofundada, é interessante realizar uma regressão linear separadamente para cada região e para cada ano, a fim de capturar melhor a complexidade e a heterogeneidade dos dados.

```{r message=FALSE, warning=FALSE}
gapminder_vac %>% 
  filter(vaccine == "BCG") %>% 
ggplot() +
  aes(x = coverage,
    y = lifeExp,
    color = continent) +
  geom_point(shape = "circle",
             aes(colour = continent,
                 size = pop),
             alpha = 0.2) +
  geom_smooth(aes(group = continent,
                  color = continent),
              method = "lm",
              se = F)+
  stat_correlation(method = "pearson",
                   size = 2,
                   mapping = use_label(c("R", "R2", "n"))) +
  facet_wrap(~year)+
  theme_few() +
  labs(title = "Cobertura vacinal e Expectativa de vida",
       subtitle = "Vacina BCG", 
       x = "Cobertura vacinal (%)",
       y = "Expectaiva de vida (anos)",
       color = "Continente",
       shape = "População") +
  scale_color_jama()
```

Observamos que, ao estratificarmos a análise por continente, a correlação entre a cobertura vacinal da BCG e a expectativa de vida tornou-se mais forte, com uma dispersão reduzida em torno da reta de regressão. Em outras palavras, a cobertura vacinal da BCG apresentou uma capacidade maior de explicar a variação na expectativa de vida em diferentes continentes.

Esse resultado é muito interessante, pois a vacinação com a BCG é uma das principais estratégias para o controle da tuberculose. Historicamente, a tuberculose estava presente em diversas condições sociais e econômicas, afetando tanto as classes com menor renda quanto as mais abastadas. No entanto, mais recentemente, a doença tornou-se mais associada às condições sociais e econômicas da população, com pacientes com HIV/AIDS apresentando um risco ainda maior de morte pela tuberculose.

```{r message=FALSE, warning=FALSE}
#Manipulação
gapminder_mortes = gapminder %>% 
  left_join(mortes_doencas %>% rename(country = name) %>% select(-continent),
            by = join_by(country, year)) %>% 
  mutate(income = case_when(
    gdpPercap < 1035 ~ "Baixa",
    gdpPercap >= 1035 & gdpPercap < 4085 ~ "Média-baixa",
    gdpPercap >= 4085 & gdpPercap < 12615 ~ "Média-alta",
    gdpPercap >= 12615 ~ "Alta"
  ))

gapminder_mortes %>% 
    filter(year %in% c(1972, 1982, 1992, 2007)) %>% 
  filter(death_disease == "Tuberculosis") %>% 
 ggplot() +
  aes(x = death_rate_100thousand_age_standardized, 
      y = fct_rev(income), 
      fill = income) +
   geom_density_ridges() +
  theme_few()+
  theme(plot.caption = element_text(size = 13L),
        legend.position = "right",
        axis.title.x = element_text(vjust = -1),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(hjust = 0.5),
        strip.text.x = element_text(size = 10,
                                    color = "black")) +
  facet_wrap(~year, scales = "free") +
  labs(title = "Mortes por 100 mil habitantes, por continente",
       subtitle = "Tuberculose", 
       x = "Mortes por 100 mil habitantes",
       y = "",
       fill = "Renda") +
  scale_fill_jama()
```

No gráfico abaixo, veja que a maioria dos Top 10 países com maior número de mortes por tuberculose deixaram de ser aqueles de alta renda e se concentraram nos de baixa e média renda, ao longo dos anos. Alguns países aparentemente tiveram surtos da doença, com números elevados de mortes, como as Filipinas em 1992, e a África do Sul, em 2007.

```{r}
gapminder_mortes %>% 
  filter(year %in% c(1972, 1982, 1992, 2007),
         death_disease == "Tuberculosis") %>% 
  group_by(year) %>%
  arrange(desc(death_rate_100thousand_age_standardized)) %>%
  slice_head(n = 10) %>%
  ungroup()%>% 
 ggplot() +
  aes(x = death_rate_100thousand_age_standardized, 
      y = fct_reorder(country, death_rate_100thousand_age_standardized), 
      fill = income) +
  geom_col() +
  theme_few()+
  theme(plot.caption = element_text(size = 13L),
        legend.position = "right",
        axis.text.x = element_text(angle = 90,
                                   size = 5),
        strip.text.y = element_text(angle = 0, 
                                    hjust = 0)) +
  facet_wrap(~year, scales = "free") +
  labs(title = "Mortes por 100 mil habitantes, por país e renda",
       subtitle = "Tuberculose", 
       x = "Mortes por 100 mil habitantes",
       y = "",
       fill = "Renda") +
  scale_fill_jama()
```

Além disso, podemos visualizar essa associação ao plotarmos as mortes por tuberculose em relação ao PIB per capita. Notamos que, embora a correlação entre as mortes e o PIB per capita seja intermediária, houve uma redução gradual dessa correlação entre 1952 e 2007. Essa redução pode ser atribuída, em grande parte, ao aumento da cobertura vacinal, como discutido anteriormente.

```{r message=FALSE, warning=FALSE, fig.width = 10, fig.height = 6}
gapminder_mortes %>% 
    filter(year <= 2007) %>% 
  filter(death_disease == "Tuberculosis") %>% 
ggplot() +
  aes(x = gdpPercap,
    y = death_rate_100thousand_age_standardized) +
  geom_point(shape = "circle",
             aes(colour = income,
                 size = pop),
             alpha = 0.2) +
  scale_x_continuous(trans = "log10",
                     labels = scales::unit_format(unit = "k",
                                                  scale = 1e-3)) +
   geom_smooth(method = "lm",
              color = "black",
              se = F) +
  stat_correlation(method = "pearson",
                   size = 3,
                   mapping = use_label(c("R", "R2", "n"))) + 
  facet_wrap(~year, scales = "free") +
  theme_few() +
  labs(title = "PIB per capita e Mortes por doenças imunopreveníveis",
       subtitle = "Tuberculose", 
       x = "PIB per capita",
       y = "Mortes por 100 mil habitantes",
       color = "Renda",
       shape = "População") +
  scale_color_jama()
```

Testando correlações entre mais pares de variáveis.

```{r message=FALSE, warning=FALSE, fig.width = 10, fig.height = 10}
gapminder_mortes %>% 
  filter(year <= 2007,
         death_disease == "Tuberculosis") %>% 
  ggpairs(columns = c("year", 
                      "lifeExp", 
                      "pop", 
                      "gdpPercap", 
                      "death_rate_100thousand_age_standardized"),
          columnLabels = c("Ano",
                           "Expectativa de vida",
                           "População",
                           "PIB per capita",
                           "Mortes/100k Hab."),
          mapping = aes(color = continent, alpha = 0.5)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  labs(title = "Tuberculose",
       subtitle = "Variáveis demográficas e mortalidade") +
  scale_color_jama() +
  scale_fill_jama()
```

## Gráficos dinâmicos

O gráfico de forma estática já nos mostrou muito sobre o comportamento dos dados, mas podemos explorá-los de forma mais dinâmica com uma animação. Para isso, usaremos o pacote `gganimate` e separaremos os continentes em facets.

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
gapminder_mortes %>% 
  mutate(year = as.integer(year)) %>% 
ggplot() +
  aes(gdpPercap, death_rate_100thousand_age_standardized, colour = country) +
  geom_point(alpha = 0.7, show.legend = FALSE, mapping = aes(size = pop)) +
  scale_size(range = c(5, 5)) +
  scale_x_continuous(trans = "log10",
                     labels = scales::unit_format(unit = "k",
                                                  scale = 1e-3)) +
  theme_few() + 
  scale_colour_manual(values = country_colors) +
  facet_wrap(~continent) +
  # Animação
  labs(title = "Mortes por tuberculose",
       subtitle = 'Ano: {frame_time}', 
       x = 'PIB per capita', 
       y = 'Mortes por 100 mil habitantes') +
  transition_time(year) +
  ease_aes('linear')
```
